<!DOCTYPE html>
<html>

<head>
    <title>kellyjandrews</title>
    <link rel='stylesheet' href='/assets/css/styles.css' type='text/css' media='all' />
    <script src="/assets/js/bundle.js"></script>
    <link rel="alternate" type="application/rss+xml" title="kellyjandrews" href="/rss/">
    <link rel="canonical" href="http://kellyjandrews.com/" />
</head>


<body>
  <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="row">
    <div class="col-md-6">
      <header class="site-header">
        <h1>
            <a href="/" title="kellyjandrews">kelly j andrews</a>
        </h1>
    </header>
</div>
    <div class="col-md-6 text-right">
      <a href="/experience" class="navlink"><i class="fa fa-info-circle fa-2x"></i></a>
      <a href="https://github.com/kellyjandrews" target="_blank"><i class="fa fa-github fa-2x"></i></a>
      <a href="https://twitter.com/kellyjandrews" target="_blank" ><i class="fa fa-twitter fa-2x"></i></a>
      <a href="https://www.linkedin.com/in/kjandrews/en" target="_blank" ><i class="fa fa-linkedin fa-2x"></i></a>
      <a href="https://stackexchange.com/users/2222625/kelly-j-andrews" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
  </div>
  </div>
  </div>
</nav>


    <div class="container-fluid">
        <div class="padded">
	<div class="col-md-8 col-md-offset-2">
  <h1>Ghost Proxied Through Heroku App</h1>
<p>Over the last couple of days, I have been pounding my head against the wall of what is known as a proxy. I wanted to capture everything I did to make it work, and hope it helps someone down the road attempting the same thing.</p>

<h4 id="background">Background</h4>
<p>I have been working on documentation utilizing <a href="http://www.assemble.io">Assmeble.io</a> - a great Static-Site-Generator (SSG) created by <a href="https://github.com/jonschlinkert">Jon Schlinkert</a> and <a href="https://github.com/doowb">Brian Woodward</a>. Great tool to build out documentation.</p>

<p>I am pushing my static files to <a href="http://www.heroku.com/">Heroku</a>, and using <a href="http://expressjs.com/">Expressjs</a> to serve the static files.  This part was super simple with the following code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">'/public'</span><span class="p">));</span>

<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">5000</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Listening on "</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Everything worked great, and it’s super fast. Anyone looking to create documentation - it’s a great way to go, and I’ll be blogging more about how this works in the coming weeks.</p>

<h4 id="additional-requirements">Additional Requirements</h4>
<p>Assmeble.io offers a method of blogging.  For most of us, it’s fairly straight forward, and if you have developers doing your blogging, it will work for you.  It involves rebuilding your static <code class="highlighter-rouge">html</code> files and pushing up the changes.</p>

<p>For those who are less inclined to create files and push code to a server, you may want to consider an alternative. I found myself needing a blogging platform that required a bit more non-developer love.</p>

<p>Since Assemble is build on <a href="http://nodejs.org/">Node</a>, <a href="http://gruntjs.com/">Grunt</a>, and <a href="http://handlebarsjs.com/">Handlebars</a>, the most logical choice was <a href="https://ghost.org/">Ghost</a>.  I went this direction in order to keep my templating straight forward and not recode them in order to use something like <a href="http://wordpress.org/">Wordpress</a> where I would need to change them into <code class="highlighter-rouge">PHP</code>.</p>

<p>I easily made a new Grunt task to take my existing templates, and built new template files specifically for Ghost. How I did this is out of scope for this article, but something I want to share in the future, so watch for that in the next couple weeks.</p>

<h4 id="seperation-of-concerns">Seperation of Concerns</h4>
<p>What I quickly realized, was that I couldn’t easily run two Express apps on one Heroku app. Realistically - you probably shouldn’t anyhow, so it needed to be a seperate app.  I now have two Heroku apps running - {site}.herokuapp.com and {site-blog}.herokuapp.com.</p>

<p>Each app ran individually as expected, and things were looking like it was the right direction.</p>

<h4 id="then-i-hit-a-brick-wall">Then I Hit a Brick Wall</h4>
<p>Setting up a <a href="https://github.com/nodejitsu/node-http-proxy">Node-HTTP-Proxy</a> looked like it was the way to go.  It all seemed fairly easy at first, but I had to work around some issues.</p>

<p>Adding the following code get’s the proxy started:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">httpProxy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http-proxy'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">httpProxy</span><span class="p">.</span><span class="nx">createProxyServer</span><span class="p">();</span>
</code></pre>
</div>

<p>You then need to set up the routes to work correctly. I wanted to use {site}.herokuapp.com/blog to serve up my blog site.  In Ghost, there are a few <code class="highlighter-rouge">HTTP</code> methods you have to be concerned with for it al to function properly - <code class="highlighter-rouge">GET</code>, <code class="highlighter-rouge">POST</code>, <code class="highlighter-rouge">PUT</code>, <code class="highlighter-rouge">DELETE</code>.  So far, these are all of the ones I have run into, but if any others pop up, you would cut and past the same code and change the method.</p>

<p>I started with (only listing the <code class="highlighter-rouge">GET</code> route here):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/blog*'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">proxy</span><span class="p">.</span><span class="nx">web</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">target</span><span class="p">:</span> <span class="s1">'{site-blog}.herokuapp.com'</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>I tried various formats of this, getting hit with <code class="highlighter-rouge">503</code>, <code class="highlighter-rouge">500</code>, and <code class="highlighter-rouge">404</code> errors, or simply a blank page. What once seemed to be working locally - was no longer functioning as expected.</p>

<p>I finally got back an error in Heroku reading “No Such App”. I was getting close. Google search popped up with a post on <a href="http://stackoverflow.com/questions/6444280/heroku-no-such-app-error-with-node-js-node-http-proxy-module">StackOverflow</a> which FINALLY (I at this point spent about 10 hours trying to get settings to work). I modified my code to this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/blog*'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="s1">'{site-blog}.herokuapp.com'</span><span class="p">;</span>
    <span class="nx">proxy</span><span class="p">.</span><span class="nx">web</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">target</span><span class="p">:</span> <span class="s1">'{site-blog}.herokuapp.com'</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>After pushing the changes to Heroku - I fired it up, and got a <code class="highlighter-rouge">404</code> - from Ghost. This is where some folks would lose it - after all the frustration, still getting nowhere. However - I knew differently - this was a huge win - I got something back from the server.</p>

<p>The final change I had to make was on the Ghost <code class="highlighter-rouge">config.js</code> file.  I’m running my <code class="highlighter-rouge">NODE_ENV</code> as production, so my production object initially looked like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">production</span><span class="err">:</span> <span class="p">{</span>
    <span class="nl">url</span><span class="p">:</span> <span class="s1">'{site-blog}.herokuapp.com'</span><span class="p">,</span>
    <span class="nx">mail</span><span class="err">:</span> <span class="p">{},</span>
    <span class="nx">database</span><span class="err">:</span> <span class="p">{</span>
        <span class="nl">client</span><span class="p">:</span> <span class="s1">'postgres'</span><span class="p">,</span>
        <span class="nx">connection</span><span class="err">:</span> <span class="p">{</span>
            <span class="nl">host</span><span class="p">:</span> <span class="s1">'{myhost}'</span><span class="p">,</span>
            <span class="nx">user</span><span class="err">:</span> <span class="s1">'{myuser}'</span><span class="p">,</span>
            <span class="nx">password</span><span class="err">:</span> <span class="s1">'{mypassword}'</span><span class="p">,</span>
            <span class="nx">database</span><span class="err">:</span> <span class="s1">'{mydbname}'</span><span class="p">,</span>
            <span class="nx">port</span><span class="err">:</span> <span class="s1">'{myport}'</span>
        <span class="p">},</span>
        <span class="nx">debug</span><span class="err">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="nx">server</span><span class="err">:</span> <span class="p">{</span>
        <span class="nl">host</span><span class="p">:</span> <span class="s1">'0.0.0.0'</span><span class="p">,</span>
        <span class="nx">port</span><span class="err">:</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">2368</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">},</span>
</code></pre>
</div>

<p>This is fine if I’m running it as normal, but I’m running as a subdirectory, and a proxy. So I changed the <code class="highlighter-rouge">url</code> to this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">url</span><span class="err">:</span> <span class="s1">'{site}.herokuapp.com/blog'</span><span class="p">,</span>
</code></pre>
</div>

<p>Now it was expecting to see the base files served from my Express server under the subdirecory <code class="highlighter-rouge">/blog</code>.</p>

<p>All of the routes function, the admin, the front end, everything.  I still have to work out some of the templating issues, but that’s a cake walk at this point.</p>

<p>Getting this up and running was the best feeling, and it all works like a charm.  Hopefully this helps you if you are trying to do the same thing.</p>





<div id="disqus_thread"></div>
   <script type="text/javascript">
       /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
       var disqus_shortname = 'kellyjandrews'; // required: replace example with your forum shortname
       var disqus_title = "Ghost Proxied Through Heroku App";
       /* * * DON'T EDIT BELOW THIS LINE * * */
       (function() {
           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
   </script>
   <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>

</div>

    </div>

    <footer class="text-center">
    <small>All content copyright <a href="/">kelly j andrews</a> &copy; 2016 &bull; All rights reserved.</small>
    </a>
</footer>

    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-47461674-1', 'kellyjandrews.com');
    ga('send', 'pageview');
</script>
</body>

</html>
